@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(person, "Person", "Клиент")

Boundary(internal, "Bank Platform") {
  Container(apiGw, "Api Gateway", "Nginx", "Балансировка и безопасность")
  Container(idP, "Identity Provider", "Keycloak", "Логин пользователя, выдача authorization code и токенов")
  Container(wallet, "Wallet Service", "Java/Spring", "OAuth2 Resource Server \n  Validates User JWT and Service JWT \n списание/пополнение")
  Container(transaction, "Transaction Service", "Java/Spring", "Проведение платежа")
  Container(payment, "Payment Gateway Service", "Интеграция с внешним провайдером")
  Container(callback, "Callback Service", "Java/Spring", "Обработка callback")
  Container(callbackGw, "Callback Gateway", "Nginx", "Безопасность")
  Container(paymentQuery, "Payment Query Service", "Java/Spring", "OAuth2 Resource Server \n Validates User JWT \n + получение информации по платежам")

  ContainerDb(walletDb, "Wallet DB + Debezium/Kafka Connect", "PostgreSQL", "Счета пользователей, платежи и outbox-события PaymentInitiated/PaymentResult")
  ContainerDb(transactionDb, "Transaction DB + Debezium/Kafka Connect", "PostgreSQL", "Состояние платежей, история и outbox-события")
  ContainerDb(callbackDb, "Callback DB + Debezium/Kafka Connect", "PostgreSQL", "Статус платежей и outbox-события")
  ContainerDb(paymentDb, "Payment DB + Debezium/Kafka Connect", "PostgreSQL", "Статус платежей и outbox-события")
  ContainerDb(paymentQueryDb, "PaymentQuery DB", "ClickHouse", "Информация о платежах")
  ContainerDb(paymentQueryRedis, "PaymentQuery DB", "Redis", "Информация о платежах (Cache)")

  Container(kafka, "Kafka", "Event Broker", "Асинхронный обмен событиями между сервисами")
}


System_Ext(extPayment, "External Payment Provider")

Rel(person, apiGw, "HTTP")
Rel(apiGw, wallet, "Проксирование API вызовов + Authorisation: Bearer <JWT>", "HTTPS")
Rel(apiGw, paymentQuery, "Проксирование API вызовов + Authorisation: Bearer <JWT>", "HTTPS")
Rel(apiGw, idP, "OIDC Authorization Code Flow", "HTTPS")
Rel(callbackGw, idP, "OIDC Authorization Code Flow", "HTTPS")
Rel(wallet, walletDb, "JDBC", "Запись платежа, резерва и событие в outbox")
Rel(wallet, walletDb, "JDBC", "При успехе: подтверждение списания. При неудаче: отмена(компенсация)")
Rel(walletDb, kafka, "Outbox", "Публикует событие PaymentInitiated")
Rel(kafka, transaction, "Kafka event", "PaymentInitiated")
Rel(kafka, wallet, "Event Broker", "PaymentResult")
Rel(transaction, payment, "HTTPS", "Внешний вызов через gateway")
Rel(payment, extPayment, "HTTPS", "Внешний вызов API(дебетование)")
Rel(payment, paymentDb, "HTTPS", "Внешний вызов API(дебетование)")
Rel(paymentDb, kafka, "Outbox", "PaymentResult")
Rel(kafka, transaction, "Kafka event", "PaymentResult")
Rel(extPayment, callbackGw, "HTTPS", "Финальный статус платежа")
Rel(callbackGw, callback, "HTTPS", "Финальный статус платежа")
Rel(kafka, transaction, "Kafka event", "PaymentResult")
Rel(kafka, paymentQuery, "Kafka event", "PaymentInitiated")
Rel(kafka, paymentQuery, "Kafka event", "PaymentResult")
Rel(callback, callbackDb, "Kafka", "Обновление статуса платежа")
Rel(callbackDb, kafka, "Outbox", "ProviderCallbackReceived")
Rel(paymentQuery, paymentQueryRedis, "JDBC", "Информация о платеже")
Rel(paymentQuery, paymentQueryDb, "JDBC", "Информация о платеже")
Rel(transaction, transactionDb, "JDBC", "Обновление статуса платежа, запись, события PaymentResult в Outbox")
Rel(transactionDb, kafka, "Event Broker", "PaymentResult")

@enduml
